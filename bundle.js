(()=>{"use strict";var e,t,n,o,r,a,i,d,l,s,u,c,m,p,w,f,v,y,h,g,L,q,S,_,E,A,F,k;e=function(e){return Math.floor(Math.random()*e.length)},window.util={generateRandomArrayItemNumber:e,getRandomArrayItem:function(t){return t[e(t)]},shuffleArray:function(e){for(var t,n=e.length,o=0;n--;)o=Math.floor(Math.random()*(n+1)),t=e[n],e[n]=e[o],e[o]=t;return e}},window.debounce=function(e){t&&window.clearTimeout(t),t=window.setTimeout(e,500)},n=document.querySelector(".map__filters"),o=Array.from(n.children),r=n.querySelector("#housing-type"),a=n.querySelector("#housing-price"),i=n.querySelector("#housing-rooms"),d=n.querySelector("#housing-guests"),l=n.querySelector("#housing-features").querySelectorAll('input[type="checkbox"]'),window.adFilter={resetAdFilter:function(){n.reset()},disableAdFilterForm:function(){for(var e=0;e<o.length;e++)o[e].disabled=!0},enableAdFilterForm:function(){for(var e=function(){window.map.renderAdPins(window.load.data)},t=0;t<o.length;t++)o[t].disabled=!1;n.addEventListener("change",(function(){window.debounce(e)}))},filterAdData:function(e){for(var t in l)if(l.hasOwnProperty(t)){var n=l[t];if(n.checked&&!e.offer.features.includes(n.value))return!1}return!("any"!==r.value&&r.value!==e.offer.type||"any"!==a.value&&a.value!==(o=e.offer.price,o<1e4?"low":o>5e4?"high":"middle")||"any"!==i.value&&parseInt(i.value,10)!==e.offer.rooms||"any"!==d.value&&parseInt(d.value,10)!==e.offer.guests);var o}},window.load=function(e,t){var n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){var o;switch(n.status){case 200:e(n.response),window.load.data=n.response,window.adFilter.enableAdFilterForm();break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;default:o="Cтатус ответа: : "+n.status+" "+n.statusText}o&&t(o)})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()},u=(s=document.querySelector(".map")).querySelector(".map__pin--main"),c=document.querySelector(".map__pins"),m=document.querySelector("#pin").content.querySelector(".map__pin"),p=function(e){var t=m.cloneNode(!0);return t.style="left: "+e.location.x+"px; top: "+e.location.y+"px;",t.querySelector("img").src=e.author.avatar,t.querySelector("img").alt=e.offer.title,t.addEventListener("click",(function(){window.card.showAdCard(e)})),t},w=function(){for(var e=c.querySelectorAll(".map__pin:not(.map__pin--main)"),t=0;t<e.length;t++)e[t].remove()},window.map={mapElement:s,mainMapPin:u,fadeMap:function(){s.classList.add("map--faded")},showMap:function(){s.classList.remove("map--faded")},renderAdPins:function(e){window.card.removeAdCard(),w();for(var t=e.filter((function(e){return window.adFilter.filterAdData(e)})).slice(0,5),n=document.createDocumentFragment(),o=0;o<t.length;o++)0!==t[o].offer.length&&n.appendChild(p(t[o]));c.appendChild(n)},removeRenderedAdPins:w},f=function(){window.map.mapElement.querySelector(".popup__close")&&window.map.mapElement.querySelector(".popup__close").parentNode.remove()},v=function(e){27===e.keyCode&&(e.preventDefault(),f())},window.card={showAdCard:function(e){f();var t=window.map.mapElement.querySelector(".map__filters-container"),n=document.createDocumentFragment();n.appendChild(function(e){var t=document.querySelector("#card").content.querySelector(".popup").cloneNode(!0),n=t.querySelector(".popup__title"),o=t.querySelector(".popup__text--price"),r=t.querySelector(".popup__type"),a=t.querySelector(".popup__text--capacity"),i=t.querySelector(".popup__text--time"),d=t.querySelector(".popup__features"),l=t.querySelector(".popup__description"),s=t.querySelector(".popup__photos"),u=t.querySelector(".popup__avatar");if(0!==e.offer.title.length?n.textContent=e.offer.title:n.classList.add("hidden"),0!==e.offer.price.length?o.textContent=e.offer.price+"₽/ночь":o.classList.add("hidden"),0!==e.offer.type.length?r.textContent={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"}[e.offer.type]:r.classList.add("hidden"),0!==e.offer.rooms.length&&0!==e.offer.guests.length?a.textContent=`${e.offer.rooms} комнаты для ${e.offer.guests} гостей.`:0!==e.offer.rooms.length&&0===e.offer.guests.length?a.textContent=e.offer.rooms+" комнаты.":0===e.offer.rooms.length&&0!==e.offer.guests.length?a.textContent=`Для ${e.offer.guests} гостей.`:a.classList.add("hidden"),0!==e.offer.checkin.length&&0!==e.offer.checkout.length?i.textContent=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}.`:i.classList.add("hidden"),0!==e.offer.features.length){for(var c=document.createDocumentFragment(),m=0;m<e.offer.features.length;m++){var p=document.createElement("li");p.classList.add("popup__feature","popup__feature--"+e.offer.features[m]),c.appendChild(p)}d.appendChild(c)}else d.classList.add("hidden");if(0!==e.offer.description.length?l.textContent=e.offer.description:l.classList.add("hidden"),0!==e.offer.photos.length){for(var w=document.createDocumentFragment(),f=0;f<e.offer.photos.length;f++){var v=document.createElement("img");v.classList.add("popup__photo"),v.width="45",v.height="40",v.src=e.offer.photos[f],v.alt="Фотография "+(f+1)+" - "+e.offer.title,w.appendChild(v)}s.appendChild(w)}else s.classList.add("hidden");return 0!==e.author.avatar.length?(u.src=e.author.avatar,u.alt="User avatar"):(u.src="img/avatars/default.png",u.alt="Default avatar"),t}(e)).querySelector(".popup__close").addEventListener("click",(function(){f()})),document.addEventListener("keydown",v),window.map.mapElement.insertBefore(n,t)},removeAdCard:f},(()=>{var e=document.querySelector(".ad-form"),t=e.querySelector("#address"),n=e.querySelectorAll(".ad-form-header, .ad-form__element"),o=e.querySelector("#price"),r=e.querySelector("#type"),a=e.querySelector("#timein"),i=e.querySelector("#timeout"),d=e.querySelector("#room_number"),l=e.querySelector("#capacity"),s=parseInt(window.map.mainMapPin.style.left,10)+31,u=parseInt(window.map.mainMapPin.style.top,10)+31;r.addEventListener("input",(function(){"bungalow"===r.value?(o.min=0,o.placeholder="0"):"flat"===r.value?(o.min=1e3,o.placeholder="1000"):"house"===r.value?(o.min=5e3,o.placeholder="5000"):"palace"===r.value&&(o.min=1e4,o.placeholder="10000")}));var c=function(){"1"===d.value?"1"===l.value?l.setCustomValidity(""):l.setCustomValidity("В однокомнатном помещении может расположиться один гость."):"2"===d.value?"1"===l.value||"2"===l.value?l.setCustomValidity(""):l.setCustomValidity("Двухкомнатное помещение доступно для 1-го или 2-ух гостей."):"3"===d.value?"1"===l.value||"2"===l.value||"3"===l.value?l.setCustomValidity(""):l.setCustomValidity("Трёхкомнатное помещение доступно для 1-го, 2-ух или 3-ёх гостей."):"100"===d.value&&("0"===l.value?l.setCustomValidity(""):l.setCustomValidity("Не для гостей!"))},m=e.querySelector(".ad-form__reset"),p=function(e){e.preventDefault(),window.main.deactivatePage(),window.newAdForm.resetFormButton.removeEventListener("click",p)};e.addEventListener("change",c),a.addEventListener("change",(function(){12===parseInt(a.value,10)?(i.querySelector("#timeout12").disabled=!1,i.querySelector("#timeout13").disabled=!0,i.querySelector("#timeout14").disabled=!0):13===parseInt(a.value,10)?(i.querySelector("#timeout12").disabled=!1,i.querySelector("#timeout13").disabled=!1,i.querySelector("#timeout14").disabled=!0):14===parseInt(a.value,10)&&(i.querySelector("#timeout12").disabled=!1,i.querySelector("#timeout13").disabled=!1,i.querySelector("#timeout14").disabled=!1)})),window.newAdForm={fillOutAddressInactive:function(){t.value=s+", "+u},disableNewAdForm:function(){for(var t=0;t<n.length;t++)n[t].disabled=!0;e.classList.add("ad-form--disabled")},enableNewAdForm:function(){for(var t=0;t<n.length;t++)n[t].disabled=!1;e.classList.remove("ad-form--disabled")},matchRoomNumberWithCapacity:c,newAddressField:t,newAdForm:e,resetNewAdForm:function(){e.reset()},resetFormButton:m,onClickResetForm:p}})(),y=window.newAdForm.newAdForm.querySelector(".ad-form-header"),h=y.querySelector(".ad-form-header__preview").querySelector("img"),g=y.querySelector(".ad-form-header__input"),L=window.newAdForm.newAdForm.querySelector(".ad-form__photo-container"),q=L.querySelector(".ad-form__input"),S=L.querySelector(".ad-form__photo"),_=["png","jpg","jpeg"],g.addEventListener("change",(function(){var e=g.files[0],t=e.name.toLowerCase();if(_.some((function(e){return t.endsWith(e)}))){var n=new FileReader;n.addEventListener("load",(function(){h.src=n.result,window.readerResult=n.result})),n.readAsDataURL(e)}})),q.addEventListener("change",(function(){var e=q.files[0],t=e.name.toLowerCase();if(_.some((function(e){return t.endsWith(e)}))){var n=new FileReader;n.addEventListener("load",(function(){var e,t,o,r;e=S,t=n.result,o=document.createDocumentFragment(),(r=document.createElement("img")).src=t,r.width=70,r.height=70,r.alt="Фотография помещения",r.style.borderRadius="5px",o.appendChild(r),e.appendChild(o)})),n.readAsDataURL(e)}})),E=function(){var e=parseInt(window.map.mainMapPin.style.left,10)+31,t=parseInt(window.map.mainMapPin.style.top,10)+82;window.newAdForm.newAddressField.value=e+", "+t},window.pin={onMouseDownPin:function(e){var t=1168;e.preventDefault(),window.startCoordinates={x:e.clientX,y:e.clientY};var n=!1,o=function(e){e.preventDefault(),n=!0;var o=window.startCoordinates.x-e.clientX,r=window.startCoordinates.y-e.clientY;window.startCoordinates={x:e.clientX,y:e.clientY};var a=window.map.mainMapPin.offsetLeft-o,i=window.map.mainMapPin.offsetTop-r;a>=-32&&a<=t&&i>=130&&i<=630?(window.map.mainMapPin.style.top=i+"px",window.map.mainMapPin.style.left=a+"px"):a<-32?(window.map.mainMapPin.style.top=i+"px",window.map.mainMapPin.style.left="-32px"):a>t?(window.map.mainMapPin.style.top=i+"px",window.map.mainMapPin.style.left="1168px"):i<130?(window.map.mainMapPin.style.top="130px",window.map.mainMapPin.style.left=a+"px"):i>630&&(window.map.mainMapPin.style.top="630px",window.map.mainMapPin.style.left=a+"px"),E()},r=function(e){n||E(),e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r)},introduceActivePinPosition:E},A=document.querySelector("main"),F=function(){var e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),t=document.createDocumentFragment().appendChild(e);A.appendChild(t);var n=document.querySelector(".success"),o=function(e){e.preventDefault(),n.remove(),window.main.deactivatePage(),document.removeEventListener("keydown",r),window.removeEventListener("click",o)},r=function(e){e.preventDefault(),27===e.keyCode&&(n.remove(),window.main.deactivatePage(),window.removeEventListener("click",o),document.removeEventListener("keydown",r))};document.addEventListener("keydown",r),window.addEventListener("click",o)},k=function(){var e=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),t=document.createDocumentFragment().appendChild(e);A.appendChild(t);var n=document.querySelector(".error"),o=function(e){e.preventDefault(),27===e.keyCode&&(a.removeEventListener("click",i),n.remove(),window.removeEventListener("click",r),document.removeEventListener("keydown",o))},r=function(e){e.preventDefault(),a.removeEventListener("click",i),n.remove(),document.removeEventListener("keydown",o),window.removeEventListener("click",r)},a=n.querySelector(".error__button"),i=function(e){e.preventDefault(),a.removeEventListener("click",i),n.remove(),document.removeEventListener("keydown",o),window.removeEventListener("click",r)};document.addEventListener("keydown",o),window.addEventListener("click",r),a.addEventListener("click",i)},window.upload=function(e,t,n){var o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){300===o.status?t():n()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},window.newAdForm.newAdForm.addEventListener("submit",(function(e){e.preventDefault(),window.upload(new FormData(window.newAdForm.newAdForm),F,k)})),(()=>{var e=function(e){var t=document.createElement("div");t.style="color: #fff; z-index: 100; margin: 0 auto; padding: 5px 0; top: 0; text-align: center; background-color: tomato; box-shadow: 0 0 5px 5px tomato;",t.style.position="sticky",t.style.left=0,t.style.right=0,t.style.fontSize="25px",t.textContent="× "+e+" ×",document.body.insertAdjacentElement("afterbegin",t)},t=function(){window.map.fadeMap(),window.adFilter.disableAdFilterForm(),window.newAdForm.disableNewAdForm(),window.adFilter.resetAdFilter(),window.newAdForm.resetNewAdForm(),window.newAdForm.fillOutAddressInactive(),window.card.removeAdCard(),window.map.removeRenderedAdPins(),window.addEventListener("keydown",r)},n=function(){window.map.showMap(),window.load(window.map.renderAdPins,e),window.newAdForm.enableNewAdForm(),window.pin.introduceActivePinPosition(),window.newAdForm.matchRoomNumberWithCapacity(),window.newAdForm.resetFormButton.addEventListener("click",window.newAdForm.onClickResetForm)};t();var o=function(e){e.preventDefault(),0===e.button&&window.map.mapElement.classList.contains("map--faded")&&(n(),window.removeEventListener("keydown",r),window.map.mainMapPin.removeEventListener("mousedown",o))},r=function(e){e.preventDefault(),13===e.keyCode&&window.map.mapElement.classList.contains("map--faded")&&(n(),window.removeEventListener("keydown",r),window.map.mainMapPin.removeEventListener("mousedown",(function(){o()})))};window.map.mainMapPin.addEventListener("mousedown",(function(e){o(e),window.pin.onMouseDownPin(e)})),window.addEventListener("keydown",r),window.main={deactivatePage:t}})()})();